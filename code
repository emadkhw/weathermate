import streamlit as st
import pandas as pd
import numpy as np
import requests
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import LabelEncoder
from sklearn.ensemble import GradientBoostingRegressor, GradientBoostingClassifier
from sklearn.metrics import mean_squared_error, accuracy_score
from datetime import datetime, timedelta
import pytz

# Ø¥Ø¹Ø¯Ø§Ø¯ API ÙˆÙ…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
API_KEY = '79033c69fa19e77d1d9fea1ad0e26726'
BASE_URL = 'https://api.openweathermap.org/data/2.5/'

# ÙˆØ¸Ø§Ø¦Ù Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§
def get_current_weather(city):
    url = f"{BASE_URL}weather?q={city}&appid={API_KEY}&units=metric"
    response = requests.get(url)
    data = response.json()
    return {
        'city': data['name'],
        'current_temp': round(data['main']['temp']),
        'feels_like': round(data['main']['feels_like']),
        'temp_min': round(data['main']['temp_min']),
        'temp_max': round(data['main']['temp_max']),
        'humidity': round(data['main']['humidity']),
        'description': data['weather'][0]['description'],
        'country': data['sys']['country'],
        'wind_gust_dir': data['wind']['deg'],
        'pressure': data['main']['pressure'],
        'wind_gust_speed': data['wind']['speed']
    }

def get_multiple_cities_weather(cities):
    city_data = []
    for city in cities:
        try:
            weather = get_current_weather(city)
            city_data.append({
                'city': weather['city'],
                'country': weather['country'],
                'temp': weather['current_temp']
            })
        except Exception:
            continue
    return city_data

# ÙˆØ¸ÙŠÙØ© Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù…Ù„Ø§Ø¨Ø³ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©
def clothing_recommendation(temp):
    if temp <= 10:
        return "ğŸ§¥ Ø§Ø±ØªØ¯Ù Ù…Ù„Ø§Ø¨Ø³ Ø´ØªÙˆÙŠØ© Ø«Ù‚ÙŠÙ„Ø© Ù…Ø«Ù„ Ø¬Ø§ÙƒÙŠØª ÙˆÙ…Ø¹Ø·Ù."
    elif 10 < temp <= 20:
        return "ğŸ§£ Ø§Ø±ØªØ¯Ù Ù…Ù„Ø§Ø¨Ø³ Ø®Ø±ÙŠÙÙŠØ© Ù…Ø«Ù„ Ø³ØªØ±Ø© Ø®ÙÙŠÙØ©."
    elif 20 < temp <= 30:
        return "ğŸ‘• Ø§Ø±ØªØ¯Ù Ù…Ù„Ø§Ø¨Ø³ ØµÙŠÙÙŠØ© Ø®ÙÙŠÙØ© Ù…Ø«Ù„ ØªÙŠØ´ÙŠØ±Øª ÙˆÙ‚Ù…ÙŠØµ."
    else:
        return "ğŸŒ Ø§Ø±ØªØ¯Ù Ù…Ù„Ø§Ø¨Ø³ Ø®ÙÙŠÙØ© Ø¬Ø¯Ù‹Ø§ ÙˆØ§Ø´Ø±Ø¨ Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ù…Ø§Ø¡."

# ÙˆØ¸ÙŠÙØ© Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø³ÙØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù‚Ø³
def travel_recommendations(temp):
    if temp <= 10:
        return ["Ø³ÙˆÙŠØ³Ø±Ø§ ğŸ‡¨ğŸ‡­", "Ø§Ù„Ù†Ø±ÙˆÙŠØ¬ ğŸ‡³ğŸ‡´", "Ø¢ÙŠØ³Ù„Ù†Ø¯Ø§ ğŸ‡®ğŸ‡¸"]
    elif 10 < temp <= 20:
        return ["Ø¥ÙŠØ·Ø§Ù„ÙŠØ§ ğŸ‡®ğŸ‡¹", "ÙØ±Ù†Ø³Ø§ ğŸ‡«ğŸ‡·", "Ø§Ù„ÙŠÙˆÙ†Ø§Ù† ğŸ‡¬ğŸ‡·"]
    elif 20 < temp <= 30:
        return ["Ø¥Ø³Ø¨Ø§Ù†ÙŠØ§ ğŸ‡ªğŸ‡¸", "ØªØ±ÙƒÙŠØ§ ğŸ‡¹ğŸ‡·", "Ø§Ù„Ø¨Ø±ØªØºØ§Ù„ ğŸ‡µğŸ‡¹"]
    else:
        return ["Ø¥Ù†Ø¯ÙˆÙ†ÙŠØ³ÙŠØ§ ğŸ‡®ğŸ‡©", "ØªØ§ÙŠÙ„Ø§Ù†Ø¯ ğŸ‡¹ğŸ‡­", "Ø§Ù„Ù…ÙƒØ³ÙŠÙƒ ğŸ‡²ğŸ‡½"]

# ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Streamlit
st.set_page_config(page_title="ØªØ·Ø¨ÙŠÙ‚ ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ", layout="wide")
st.title("ğŸŒ¤ï¸ ØªØ·Ø¨ÙŠÙ‚ Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø·Ù‚Ø³")

# Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
st.sidebar.header("âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚")
city = st.sidebar.text_input("ğŸŒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©", "London")
st.sidebar.markdown("---")
st.sidebar.info("ğŸ‘ˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø·Ù‚Ø³")

if city:
    st.subheader(f"ğŸŒ† Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ {city}")
    try:
        current_weather = get_current_weather(city)

        st.metric(label="ğŸŒ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©", value=f"{current_weather['city']}, {current_weather['country']}")
        col1, col2, col3 = st.columns(3)
        col1.metric("ğŸŒ¡ï¸ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©", f"{current_weather['current_temp']}Â°C")
        col2.metric("ğŸ’¨ ØªØ´Ø¹Ø± ÙƒØ£Ù†Ù‡Ø§", f"{current_weather['feels_like']}Â°C")
        col3.metric("ğŸ’§ Ø§Ù„Ø±Ø·ÙˆØ¨Ø©", f"{current_weather['humidity']}%")

        st.write(f"ğŸ“ **Ø§Ù„ÙˆØµÙ**: {current_weather['description']}")
        st.write(f"ğŸŒ¬ï¸ **Ø³Ø±Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø­**: {current_weather['wind_gust_speed']} m/s")
        st.write(f"ğŸ§­ **Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø±ÙŠØ§Ø­**: {current_weather['wind_gust_dir']}Â°")

        # Ø¹Ø±Ø¶ ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù…Ù„Ø§Ø¨Ø³
        st.subheader("ğŸ‘• ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù…Ù„Ø§Ø¨Ø³")
        recommendation = clothing_recommendation(current_weather['current_temp'])
        st.write(recommendation)

        # Ø¹Ø±Ø¶ ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø³ÙØ±
        st.subheader("âœˆï¸ Ø£ÙØ¶Ù„ Ø§Ù„Ø¨Ù„Ø¯Ø§Ù† Ù„Ù„Ø³ÙØ±")
        travel_countries = travel_recommendations(current_weather['current_temp'])
        st.write(f"ğŸŒ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ù†Ù†ØµØ­Ùƒ Ø¨Ø§Ù„Ø³ÙØ± Ø¥Ù„Ù‰: {', '.join(travel_countries)}")

        # Ø¹Ø±Ø¶ Ø£Ø¨Ø±Ø¯ ÙˆØ£Ø¹Ù„Ù‰ 5 Ù…Ù†Ø§Ø·Ù‚
        cities_list = ["Moscow", "Reykjavik", "Helsinki", "Oslo", "Stockholm", "Dubai", "Riyadh", "Cairo", "New York", "Tokyo", "Delhi", "Sydney", "Cape Town", "Buenos Aires", "Jakarta"]
        city_weather_data = get_multiple_cities_weather(cities_list)
        sorted_data = sorted(city_weather_data, key=lambda x: x['temp'])

        st.subheader("â„ï¸ Ø£Ø¨Ø±Ø¯ 5 Ù…Ø¯Ù† ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…")
        coldest_cities = sorted_data[:5]
        for city in coldest_cities:
            st.write(f"ğŸŒ {city['city']}, {city['country']} - ğŸŒ¡ï¸ {city['temp']}Â°C")

        st.subheader("ğŸ”¥ Ø£Ø¹Ù„Ù‰ 5 Ù…Ø¯Ù† Ø­Ø±Ø§Ø±Ø© ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…")
        hottest_cities = sorted_data[-5:][::-1]
        for city in hottest_cities:
            st.write(f"ğŸŒ {city['city']}, {city['country']} - ğŸŒ¡ï¸ {city['temp']}Â°C")

    except Exception as e:
        st.error(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")
else:
    st.info("â„¹ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠ.")
